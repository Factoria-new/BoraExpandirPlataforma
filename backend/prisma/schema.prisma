datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// 1. Enumeração para tipos de usuário
enum TipoUsuario {
  CLIENTE
  FINANCEIRO
  JURIDICO
  SUPER_ADMIN
}

model Usuario {
  // ID vem do Supabase Auth (UUID). Não geramos default aqui.
  id             String      @id @db.Uuid
  email          String      @unique
  nome           String?
  tipo           TipoUsuario @default(CLIENTE)
  bucketRootPath String?     @map("bucket_root_path")

  notificacoes   Notificacao[]

  criadoEm       DateTime    @default(now()) @map("criado_em")
  atualizadoEm   DateTime    @updatedAt @map("atualizado_em")

  @@map("usuarios")
}

model Notificacao {
  id        String   @id @default(uuid()) // Gerado pelo Prisma
  mensagem  String
  lida      Boolean  @default(false)
  criadoEm  DateTime @default(now()) @map("criado_em")

  usuarioId String   @db.Uuid @map("usuario_id")
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("notificacoes")
}

// Enumeração para status do documento
enum StatusDocumento {
  PENDING               // Aguardando análise
  ANALYZING             // Em análise técnica
  WAITING_APOSTILLE     // Aguardando apostilamento (cliente)
  ANALYZING_APOSTILLE   // Validando apostilamento (jurídico)
  WAITING_TRANSLATION   // Aguardando tradução (cliente)
  ANALYZING_TRANSLATION // Validando tradução (jurídico)
  WAITING_TRANSLATION_QUOTE // Aguardando orçamento de tradução
  WAITING_QUOTE_APPROVAL    // Aguardando aprovação de orçamento
  APPROVED              // Aprovado
  REJECTED              // Rejeitado
}

// Modelo para Processos
model Processo {
  id String @id @default(uuid()) @db.Uuid
  
  documentos Documento[]

  @@map("processos")
}

// Modelo para Dependentes (Membros da Família)
model Dependente {
  id String @id @default(uuid()) @db.Uuid
  
  documentos Documento[]

  @@map("dependentes")
}

// Modelo para armazenar documentos dos clientes
model Documento {
  id              String          @id @default(uuid()) @db.Uuid
  
  // Relacionamento com o cliente (UUID do Supabase)
  clienteId       String          @db.Uuid @map("cliente_id")
  
  // Novos relacionamentos
  processoId      String?         @db.Uuid @map("processo_id")
  processo        Processo?       @relation(fields: [processoId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  dependenteId    String?         @db.Uuid @map("dependente_id")
  dependente      Dependente?     @relation(fields: [dependenteId], references: [id], onDelete: SetNull)
  
  // Informações do arquivo
  tipo            String          // Tipo do documento (passport, identity, proof_of_address, etc.)
  nomeOriginal    String          @map("nome_original")  // Nome original do arquivo
  nomeArquivo     String          @map("nome_arquivo")   // Nome salvo no storage
  storagePath     String          @map("storage_path")   // Caminho completo no Supabase Storage
  publicUrl       String?         @map("public_url")     // URL pública do arquivo
  contentType     String?         @map("content_type")   // MIME type do arquivo
  tamanho         Int?            // Tamanho em bytes
  
  // Status e análise
  status          StatusDocumento @default(PENDING)
  apostilado      Boolean         @default(false)
  traduzido       Boolean         @default(false)
  motivoRejeicao  String?         @map("motivo_rejeicao")
  analisadoPor    String?         @db.Uuid @map("analisado_por") // ID do usuário que analisou
  analisadoEm     DateTime?       @map("analisado_em")
  
  // Timestamps
  criadoEm        DateTime        @default(now()) @map("criado_em")
  atualizadoEm    DateTime        @updatedAt @map("atualizado_em")

  @@index([clienteId])
  @@index([tipo])
  @@index([status])
  @@index([processoId])
  @@index([dependenteId])
  @@map("documentos")
}